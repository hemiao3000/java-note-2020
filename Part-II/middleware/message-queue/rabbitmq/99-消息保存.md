<span class="title">RabbitMQ 中的消息持久化</span>

# 基本概念

RabbitMQ 对 Queue 中消息的存储方式有 *`disk`* 和 *`RAM`* 两种。*`disk`* 就是写入磁盘，也就是通常所理解的 **持久化**，这种方式的好处是当发生系统意外宕机时，原来的消息数据可以在系统重启之后恢复。

RabbitMQ 在两种情况下会将消息数据写入磁盘：

- 在发布消息时明确指出该消息需要写入磁盘；

- 当消息服务器内存紧张时将部分内存中的消息转移到磁盘。

采用 *`disk`* 方式，消息数据会被保存在以 *`.rdq`* 后缀命名的文件中，当文件大小达到一定大小<small>（默认 16 M）</small>时会生成一个新的文件；当文件中的已经被删除的消息比例大于阈值时会触发文件合并操作，以提高磁盘利用率。

在 RabbitMQ 集群中，必须至少存在一个 *`disk`* 方式的节点，只有这样，其它节点<small>（`ram`）</small>在启动时才能直接或间接从它这里同步原来的消息数据。这正因为如此，<strong>不能手工删除集群中的最后一个 *`disk`* 节点。</strong>

# Queue 的持久化

!FILENAME Queue
```java
public Queue(String name, boolean durable)
```

可以把入参 *`durable`* 设置为 true，表示将 Queue 持久化。这意味着，RabbitMQ 服务器重启后该 Queue 仍然存在。


## Message 的持久化

对于一个持久化 Queue，在服务器重启后它是仍然存在的，但这不意味着其中<small>（未消费）</small>的消息也仍然存在。

对于这种情况，如果需要未消费的消息也仍然存在，那么需要设置消息的持久化标识。


『未完待续...』



