<span class="title">分布式消息</span>

所谓事务消息就是基于消息中间件模拟的两阶段提交（2PC），属于对中间件的一种特殊利用。总体思路如下：

<small>假设 `系统A` 做『上半场』操作，`系统B` 做『下半场』操作。</small>


1. 【系统 A】先向【消息中间件】发送一条预备消息，【消息中间件】在保存好消息之后向【系统 A】回复确认消息。

2. 【系统 A】执行本地事，做上半场操作。

3. 【系统 A】根据本地事务的执行结果向【消息中间件】发送提交消息，以确认二次提交；

4. 【消息中间件】收到提交消息后，把预备消息标记为可投递，最终将发送给【订阅者】。

对于以上 4 步，每一步都有可能出错：

- 第 1 步出错，上半场没做，下半场也没做，整个事务失败；

- 第 2 步出错，上半场失败，下半场没做，整个事务失败；

- 第 3 步出错，【系统 A】会提供一个消息回查接口，消息中间件在迟迟没有收到 【系统 A】的二次提交时，会主动询问其上半场执行结果；

  - 【系统 A】 回复执行失败，消息中间件撤销第 1 步中的预备消息；

  - 【系统 A】 回复执行成功，消息中间件继续执行第 4 步。

- 第 4 步出错，消息中间件重复发送。

结合 RocketMQ 整个流程就是：

1. 事务发起方<small>（执行上半场的那一方）</small>首先发送 prepare 消息给 Rocket MQ 。

2. Rocket MQ 向事务发起方回复 ACK 确认消息，表示已收到 prepare 消息。

3. 事务发起方接收到 ACK 确认消息后，执行本地事务。

4. 事务发起方根据本地事务的执行结果发送 `commit` 或 `rollback` 消息给 Rocket MQ，进行二次确认。

   - 如果执行结果是 rollback，则 Rocket MQ 将删除该 prepare 消息，不进行下发。

   - 如果执行结果是 commit，则 Rocket MQ 将 prepare 消息发送给 Consumer<small>（执行下半场的那一方）</small> 。 

5. 如果事务发起方<small>（执行上半场的那一方）</small>在执行事务过程中挂掉或超时，那么 Rocket MQ 在迟迟没有收到 commit 和 rollback 消息后，会对事务发起方发起消息回查。

6. 事务发起方在收到回查消息后，检查对应消息的本地执行结果。

7. 事务发起方根据本地事务的最终执行结果再次提交二次确认。

8. 发往 Consumer（执行下半场的那一方）的成功机制是由 Rocket MQ 保证的。



